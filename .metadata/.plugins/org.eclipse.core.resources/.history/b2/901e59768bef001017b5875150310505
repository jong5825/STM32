
#include "main.h"
#include <stdio.h> //printf. gets, fgets
#include <stdlib.h>
#include <string.h>

extern void delay_us(unsigned int us);

void dht11_output(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};

  GPIO_InitStruct.Pin = DHT11_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(DHT11_GPIO_Port, &GPIO_InitStruct);
}

void dht11_intput(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};

  GPIO_InitStruct.Pin = DHT11_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_INPUT;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(DHT11_GPIO_Port, &GPIO_InitStruct);
}

void dht11_main(void)
{
	enum state_t {OK, TIME_OUT, VALUR_ERROR, TRANS_ERROR};
	enum state_t state = OK;
	uint32_t us_counter = 0;

	int data[6] = {0};

	while(1)
	{
		for(int i=0; i<6; i++)
			data[i] = 0;
		state = OK;
		//======request signal======
		dht11_output();
		HAL_GPIO_WritePin(DHT11_GPIO_Port, DHT11_Pin, 1);
		HAL_Delay(100);

		HAL_GPIO_WritePin(DHT11_GPIO_Port, DHT11_Pin, 0);
		HAL_Delay(20); // 20ms


		HAL_GPIO_WritePin(DHT11_GPIO_Port, DHT11_Pin, 0);
		delay_us(30); // 20ms
		dht11_intput();

		us_counter = 0;
		while (HAL_GPIO_ReadPin(DHT11_GPIO_Port,DHT11_Pin)==0)
		{
			delay_us(2);
			us_counter += 2;
			if(us_counter > 50)
			{
				state = TIME_OUT;
				break;
			}
		}
		//---------- response start signal from DHT11-----
		if(state == OK)
		{
			us_counter = 0;
			while (HAL_GPIO_ReadPin(DHT11_GPIO_Port,DHT11_Pin)==0)
				{
					delay_us(2);
					us_counter += 2;
					if(us_counter > 100)
					{
						state = TIME_OUT;
						break;
					}
				}
		}

		if(state == OK)
		{
			us_counter = 0;
			while (HAL_GPIO_ReadPin(DHT11_GPIO_Port,DHT11_Pin))
				{
					delay_us(2);
					us_counter += 2;
					if(us_counter > 100)
					{
						state = TIME_OUT;
						break;
					}
				}
		}

		//----data read port -----
		if(state == OK)
		{

		}

	}
}

