#include "uart2.h"
#include <string.h> //strcpy, strncmp  

#define COMMAND_NUMBER 20
#define COMMAND_LENGTH 40

volatile uint8_t rx_buffer[COMMAND_NUMBER][COMMAND_LENGTH];
volatile int input_index = 0; // rx interupt에서 사용
volatile int output_index = 0; // user pram에서 사용


extern UART_HandleTypeDef huart2;
extern uint8_t rx_data;
extern int func_index;
void pc_command_processing(void);

//1 byte가 수신 될때마다 이곳으로 자동진입
void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)
{
    volatile static int i = 0;
    if(huart == &huart2)
    {
        uint8_t data;

        data = rx_data;
        if(data == '\n')
        {
            rx_buffer[input_index][i] = '\0'; // 문장의 끝을 알리는 null
            i=0;
            input_index++;
            input_index %= COMMAND_NUMBER;
            // 주의 : queue overflow 체크하는 logic을 넣어야한다.
        }
        else
        {
            rx_buffer[input_index][i++] = data;
        } 
        HAL_UART_Receive_IT(&huart2, &rx_data, 1); //반드시 집어 넣기
    }
}

void pc_command_processing(void) // 1. 여기 세미콜론 제거
{
    if(input_index != output_index)
    {
        printf("%s\n", rx_buffer[output_index]);

        // 2. 여기 세미콜론 제거 (if문 뒤에 ;가 있으면 안 됨)
        if(strncmp(rx_buffer[output_index], "led_all_on", strlen("led_all_on")) == 0)
        {
            func_index = 1;
        }
        else if(strncmp(rx_buffer[output_index], "led_all_off", strlen("led_all_off")) == 0)
        {
            func_index = 2;
        }

        output_index++;
        output_index %= COMMAND_NUMBER;
    }
}
